(function(q,v){"object"===typeof exports&&"undefined"!==typeof module?v(exports):"function"===typeof define&&define.amd?define("DCAgent",["exports"],v):v(q.DCAgent={})})(this,function(q){function v(a){return"undefined"!==typeof g[a]}function t(){}function P(a){return"function"===typeof a}function $(a){var c,b;c=Date.now();b="xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(a){var b;b=(c+16*Math.random())%16|0;c=Math.floor(c/16);return"x"===a?b.toString(16):(b&7|8).toString(16)});return(a||
"")+b.replace(/-/g,"").toUpperCase()}function Ba(a){var c,b;for(c in a)b=a[c],a[c]=b;(2<=arguments.length?[].slice.call(arguments,1):[]).forEach(function(d){var f;f=[];for(c in d)b=d[c],f.push(a[c]=b);return f});return a}function p(a,c,b){if(P(a))try{return a.apply(c,b)}catch(d){h("attemp error for "+a.toString(),d.stack)}}function Ca(a,c,b){function d(){!1!==p(a)&&F(d,c)}b?d():F(d,c)}function h(a,c){console.log("#DCAgent: "+a);c&&console.log(c)}function Da(a){try{return a.setItem(".","."),a.removeItem("."),
!0}catch(c){return!1}}function Ea(a){return a?(a=a.match(/^(https?\:)\/\/(([^:\/?#]*)(?:\:([0-9]+))?)(\/[^?#]*)(\?[^#]*|)(#.*|)$/))&&a[3]:""}function z(a,c){a=m(a);n.setItem(a,c);aa.set(a,c,365);return c}function G(a){a=m(a);return n.getItem(a)||aa.get(a)}function m(a){if(Q||R===a)return a;e.appId||h("appid should not be empty when you are in native env");return e.appId+"."+a}function Fa(a){var c=s.hash,b="!"+a;if(c){var d=/![0-9A-Z]{32,128}/gi;(c=c.match(d))?(c=c[0].slice(1),a===c||G(ba)||(e.parentId=
c,z(ba,c)),a=s.href.replace(d,b),s.replace(a)):s.replace(s.href+b)}else s.replace(s.href+"#"+b)}function ca(a){a=m(a);try{var c=JSON.parse(n.getItem(a));return Array.isArray(c)?c:[]}catch(b){return n.removeItem(a),[]}}function Ga(a,c){var b=ca(c);Array.isArray(a)?a.forEach(function(a){return b.push(a)}):b.push(a);n.setItem(m(c),JSON.stringify(b))}function Ha(){n.removeItem(m(w));n.removeItem(m(B))}function Ia(){g.addEventListener&&g.addEventListener("error",function(a){p(function(){if(u.isReportAllowed(a.filename)){u.count+=
1;var c={};["colno","filename","lineno","message"].forEach(function(b){return c[b]=a[b]||"1"});var b=a.error||{};c.stack=encodeURIComponent(b.stack||b.stacktrace||"");c.type=b.name||"Error";c.timestamp=parseInt(a.timeStamp/1E3);if(P(e.getErrorScene)&&(b=p(e.getErrorScene,b,[a]))){if(b&&"[object Object]"===da.call(b)){var d="",f;for(f in b)d+="\t"+f+"="+b[f]+"\n";b=d}else b=String(b);c.stack+="\n\nError scene:\n"+encodeURIComponent(b)}x.updateStorageByKey(c,B)}})},!1)}function Ja(){if(H)return H;S+=
1;if(!(4<S)){var a={egret:"egret",layabox:"layabox",cocos:"cc.game",impact:"ig",phaser:"Phaser",pixi:"PIXI",create:"createjs",three:"THREE",gameMaker:"asset_get_type",playCanvas:"pc.fw",turbulenz:"TurbulenzEngine",quintus:"Quintus",melon:"me.game",lychee:"lychee",wade:"wade.addSceneObject",crafty:"Crafty",lime:"lime.Scene",enchant:"enchant",isogenic:"IgeEngine",gameclosure:"GC.Application",panda:"game.Scene",kiwi:"Kiwi",jaws:"jaws",sirius2d:"ss2d",collie:"collie",physics:"Physics",stage:"Stage.Anim",
babylon:"BABYLON"},c;for(c in a){var b=a[c];if(-1<b.indexOf(".")){var b=b.split("."),d=g[b[0]];if(d&&d[b[1]])return H=c}else if(g[b])return H=c}}}function Ka(){var a;T||(T={appid:e.appId,accountid:e.accountId,uid:e.deviceId,appver:e.appVer,ver:ea,channel:e.channel,domain:l.domain||"",screen:C,logintime:String(parseInt(e.loginTime/1E3)),crtime:G(A)||""});a=T;a.onlinetime=String(e.intervalCount*e.interval/1E3||1);a.pv="0";a.engine=Ja()||"";return a}function U(a){return 0>a?I:Math.min(a,I)}function fa(a){var c=
ga();c.timeout=I;c.open("POST",a.url,!0);c.setRequestHeader("Content-Type","text/plain; charset=UTF-8");var b=Date.now();c.onreadystatechange=function(){if(4===this.readyState){var c="success"===this.responseText,f=U(Date.now()-b);p(c?a.success:a.error,this,[this,f]);p(a.complete,this,[this,f]);this.ontimeout=this.onreadystatechange=null}};c.ontimeout=function(){var c=U(Date.now()-b);p(a.error,this,[this,c,!0]);p(a.complete,this,[this,c]);this.ontimeout=this.onreadystatechange=null};c.send(JSON.stringify(a.data))}
function La(a){var c=new egret.URLLoader,b=Date.now();c.addEventListener(egret.Event.COMPLETE,function(c){var d=U(Date.now()-b);c=c.target;p("success"===c.data?a.success:a.error,c,[c,d,d>=I]);p(a.complete,c,[c,d])});var d=new egret.URLRequest(a.url);d.method=egret.URLRequestMethod.POST;d.data=JSON.stringify(a.data);c.load(d)}function ha(a,c){if(a.data){a.data.errors&&a.data.errors.length>u.max&&(e.debug&&h("sending too many errors, only "+u.max+" allowed"),a.data.errors=a.data.errors.slice(0,u.max));
for(var b in a.data)"number"===typeof a.data[b]&&(a.data[b]=String(a.data[b]));b=Math.abs(e.onlinetime);b>Ma||0>=b?e.debug&&h("illegal online time: "+b):(b=Ba({headers:Ka()},a.data),Na({url:c,data:b,success:function(b,c){r.succ=1;r.fail=0;r.total=c;p(a.success,b,[b,c])},error:function(b,c,g){r.succ=0;r.fail+=1;r.total+=c;p(a.error,b,[b,c,g]);g&&e.debug&&h("report timeout, network infomation",r)},complete:function(b,c){x.updateStorageByKey({eventid:Oa,labelmap:JSON.stringify(r),duration:"1"},w);p(a.complete,
b,[b,c])}}),e.debug&&h("report data:",b))}}function ia(a,c,b,d){var f={data:{online:{},events:a||[],errors:c||[]},success:d};b&&(f.data.reg=b);a=x.getStorageByKey(w);c=x.getStorageByKey(B);if(a.length||c.length)x.clear(),f.data.events=f.data.events.concat(a),f.data.errors=f.data.errors.concat(c),f.error=function(){e.debug&&h("report failed, restoring data to localStorage");x.updateStorageByKey(f.data.events,w);x.updateStorageByKey(f.data.errors,B)};ha(f,ja)}function ka(a,c,b){a={page:encodeURIComponent(a||
Pa),optime:parseInt(e.initializedOn),ottime:parseInt(Date.now()/1E3),lttime:parseInt(e.loginTime/1E3)};ia([{eventid:"_DESelf_PV",labelmap:JSON.stringify(a),duration:"1"}],null,c,b)}function Qa(){p(function(){if(g[J])g[J]=null;else if("function"===typeof define&&define.amd)require.undef(J);else if("object"===typeof q&&"undefined"!==typeof module){var a=require.resolve(J);delete require.cache[a]}else h("unknown module system, unload DCAgent manually please");h("DCAgent has been destroyed.")})}function Ra(){if(la)return Qa(),
!1;ma&&l[ma]||(e.intervalCount+=1,D.setItem(m(V),e.intervalCount),ia());return!0}function W(a,c){if(!y.isAgentReady()){var b=[a];[].forEach.call(c,function(a){return b.push(a)});K.push(b);return!0}}function na(a){a=m(a);try{var c=JSON.parse(n.getItem(a));return Array.isArray(c)?c:[]}catch(b){return n.removeItem(a),[]}}function Sa(a,c){var b=na(c);Array.isArray(a)?a.forEach(function(a){return b.push(a)}):b.push(a);n.setItem(m(c),JSON.stringify(b))}function Ta(){n.removeItem(m(w));n.removeItem(m(B))}
function oa(a,c,b){if(!a)h("invoke failed, missing eventId");else if(!W("onEvent",arguments)){if(null==c||1>c)c=1;var d;if(b&&"[object Object]"===da.call(b)){for(d in b)b[d.replace("%","_")]=encodeURIComponent(b[d]);d=JSON.stringify(b)}else d="";pa.updateStorageByKey({eventid:a,duration:String(c),labelmap:d},w)}}function qa(a){W("onPageView",arguments)||ka(a)}function ra(a){a&&a.hasOwnProperty("amount")&&!W("onPayment",arguments)&&(a.amount=parseFloat(a.amount)||0,ha({data:{payment:{currencyAmount:a.amount.toFixed(2),
currencyType:a.currencyType||"CNY",payType:String(a.payType||""),iapid:String(a.iapid||""),orderId:String(a.orderId||""),payTime:String(a.payTime||"")}}},ja))}function sa(a,c,b,d){c&&z(R,a);e.deviceId=a;e.accountId=e.accountId||a;var f=D.getItem(m(ta));f||(f=Date.now(),D.setItem(m(ta),f));e.loginTime=f;f=D.getItem(m(V));f||(f="0",D.setItem(m(V),f));e.intervalCount=parseInt(f);e.interval=1E3*Math.max(10,parseFloat(b.interval||e.interval));e.virus&&Ua(a);e.errorReport&&(b.excludes&&(u.excludes=u.excludes.concat(b.excludes)),
Ia());b=null;c&&(b={isact:c,isreg:1},e.parentId&&(b.parentid=e.parentId),k.localStorage||(b.localstorage=1));e.initializedOn=Date.now()/1E3;G(A)||z(A,e.initializedOn);ka(null,b);y.setReadyState(3);c={onEvent:oa,onPageView:qa,onPayment:ra};b=0;for(f=K.length;b<f;b++){var h=K[b];c[h.shift()].apply(g,h)}K.length=0;Ca(Ra,e.interval);P(d)&&d(a)}function Va(a){function c(b){p(function(){if(0===ua.indexOf(b.origin)){var d=JSON.parse(b.data);g.removeEventListener("message",c,!1);z(A,d.crtime);a(d.id)}})}
g.addEventListener("message",c,!1);var b=!1,d=Date.now(),f=l.createElement("iframe");F(function(){if(!b){var e=Date.now()-d;f.onload=null;f.parentNode.removeChild(f);g.removeEventListener("message",c,!1);z(A,parseInt(Date.now()/1E3));pa.updateStorageByKey({eventid:"WHOAMI_TIMEOUT",duration:"1",labelmap:{elapsed:e}},w);va(a)}},1E4);f.style.display="none";f.src=ua;f.onload=function(){b=!0;this.onload=null;this.parentNode.removeChild(this)};var e=function(){return l.body.appendChild(f)};l.body?e():l.addEventListener("DOMContentLoaded",
e,!1)}function va(a){z(A,parseInt(Date.now()/1E3));if(k.engine.layabox){var c=layabox.getDeviceInfo()||{},b=c.mac||c.idfa||$(wa()),b=b.replace(/[-_:=\s]+/g,"").toUpperCase();if(32>b.length){for(var c=b,b=Math.ceil(32-b.length)/2,b=void 0===b?0:b,d="",f=0;f<b;f+=1)d+="0A";b=c+d}a(b)}else a($(wa()))}function wa(){return k.engine.egret?L+Wa:k.engine.layabox?L+Xa:k.engine.cocos?L+Ya:L+Za}var X=(0,eval)("this"),g=X||{},l=X.document||{},s=X.location||{},e={appId:"",deviceId:"",accountId:"",channel:"",appVer:"",
interval:10,intervalCount:0,loginTime:0,debug:g.DCAGENT_DEBUG_OPEN},k={get engine(){return M},get localStorage(){return $a},get sessionStorage(){return ab},get postMessage(){return bb},get realBrowser(){return Q},get cookie(){return cb}},xa;if("function"===typeof l.createElement){var N=l.createElement("div");if(N&&"function"===typeof N.querySelector){N.innerHTML="<i></i>";var ya=N.querySelector("i");xa=!!ya&&"I"===ya.tagName}}var M={egret:v("egret"),layabox:v("layabox"),cocos:v("cc")},$a=!!g.localStorage||
M.egret||M.cocos,ab=!!g.sessionStorage,bb=!!g.postMessage,Q=xa,cb=Q&&"cookie"in l,F=g.setTimeout;M.egret&&(F=function(a,c){egret.setTimeout(a,g,c)});var da=Object.prototype.toString,ma="hidden"in l?"hidden":"webkitHidden"in l?"webkitHidden":"mozHidden"in l?"mozHidden":"msHidden"in l?"msHidden":null,za={getItem:t,setItem:t,removeItem:t},n=k.localStorage?g.localStorage:za,D=k.sessionStorage?g.sessionStorage:za;k.engine.egret?n=egret.localStorage:k.engine.cocos&&(n=cc.sys.localStorage);var A="dcagent_create_time",
L="ND",Wa="EGRET",Xa="LAYA",Ya="COCOS",Za="UE",ba="dcagent_parent_id",w="dcagent_client_events",B="dcagent_client_errors",ta="dcagent_login_time",V="dcagent_interval_key",R="dcagent_client_id",ja="http://rd.gdatacube.net/dc/html5/sync",ua="http://rd.gdatacube.net/dc/html5/whoami",Oa="_DESelf_OSS",I=3E4,J="DCAgent",Ma=172800,Aa,aa=Aa=k.cookie?{get:function(a){return(a=l.cookie.match(new RegExp("(^|)\\s*"+a+"=([^\\s]*)")))&&3<=a.length?decodeURIComponent(a[2]):null},set:function(a,c,b,d,f,e){var g;
b&&(g=new Date,g.setTime(g.getTime()+864E5*b));b=b?" expires="+g.toGMTString():"";f=" path="+(f||"/");d=d?" domain="+d:"";e=e?" secure":"";l.cookie=a+"="+encodeURIComponent(c)+b+f+d+e},remove:function(a,c,b){Aa.set(a,"",-1,c,b)}}:{get:t,set:t,remove:t},Ua=k.realBrowser?Fa:t,O={max:100,count:0,excludes:[],isReportAllowed:function(a){if(O.count<O.max)return O.excludes.every(function(c){return-1===a.indexOf(c)})}},u=O,x={get getStorageByKey(){return ca},get updateStorageByKey(){return Ga},get clear(){return Ha}},
ea="16";q.version=ea;var Y=g.screen||{},C=Y.width&&Y.width+"*"+Y.height;if(!C){var E;k.engine.layabox?(E=layabox.getDeviceInfo()||{},C=E.resolution||"0*0"):k.engine.cocos?(E=cc.view.getViewPortRect()||{},C=E.width+"*"+E.height):C="0*0"}var H,S=0,T,r={succ:0,fail:0,total:0},ga=function(){return new g.XMLHttpRequest},Na=function(){if(g.XMLHttpRequest)return fa;if(k.engine.cocos)return ga=function(){return cc.loader.getXMLHttpRequest()},fa;if(k.engine.egret)return La;h("XMLHttpRequest not found");return t}(),
Pa=k.realBrowser?s.pathname+s.search:"/",la=!1;q.teardown=function(){la=!0};var Z=0,y={getReadyState:function(){return Z},setReadyState:function(a){Z=a},isAgentReady:function(){return 3===Z}},K=[],pa={get getStorageByKey(){return na},get updateStorageByKey(){return Sa},get clear(){return Ta}};q.onEvent=oa;q.onPageView=qa;q.onPayment=ra;var db=k.postMessage&&k.realBrowser?Va:va;q.init=function(a,c){if(Da(n))if(0<y.getReadyState())h("DCAgent.init should be called only once");else if(a=a||{},a.appId){["errorReport",
"virus"].forEach(function(b){return e[b]=a.hasOwnProperty(b)?!!a[b]:!0});["appId","accountId","appVer","getErrorScene"].forEach(function(b){return e[b]=a[b]||""});g.QZAppExternal&&g.QZAppExternal.getPlatform&&2==g.QZAppExternal.getPlatform()&&(h("virus disabled"),e.virus=!1);e.channel=a.channel||Ea(l.referrer);var b=G(R);b?sa(b,0,a,c):(y.setReadyState(1),db(function(b){y.setReadyState(2);sa(b,1,a,c)}))}else h("init failed, missing appId");else k.localStorage?h("localstorage qouta error, private mode?"):
h("localstorage is not supported.")};var eb=y.isAgentReady;Object.defineProperty(q,"readyState",{get:function(){h("DCAgent.readyState is obsolete, use DCAgent.isReady() instead");return y.getReadyState()}});q.isReady=eb});
